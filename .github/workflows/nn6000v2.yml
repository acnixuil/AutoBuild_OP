name: nn6000v2

on:
  workflow_dispatch:
    inputs:
      subnet:
        description: "IPåœ°å€:192.168.(X).1 ä¸­çš„Xå€¼"
        required: false
        default: "3"
      cache:
        description: "ä½¿ç”¨ç¼“å­˜"
        required: true
        type: boolean
        default: true
  schedule:
    - cron: '0 22 * * 5' # æ¯å‘¨å…­ 6:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è‡ªåŠ¨ç¼–è¯‘

permissions:
  contents: write
  actions: write

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: 25.12-nss
  CUSTOM_SCRIPT: ipq6000/custom.sh
  CLASH_KERNEL: arm64
  FIRMWARE_RELEASE: true
  TZ: Asia/Shanghai
  CONFIG_FILE: ipq6000/nn6000v2.config
  FIRMWARE_TAG: nn6000v2
  RENAME_PREFIX: "" 
  DEFAULT_SUBNET: "3"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½
        run: |
          echo "è­¦å‘Šâš "
          echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
          echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡: $(nproc --all | grep -c '^')"
          echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
          echo -e "CPUå‹å·ä¿¡æ¯:$(awk -F: '/model name/ {print $2; exit}' /proc/cpuinfo)\n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯: $(sudo lshw -short -C memory | grep GiB)\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt -yqq install dos2unix rename python3-setuptools 
          sudo -E apt -yqq install libfuse-dev
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq autoclean
          sudo -E apt -yqq clean
          sudo -E systemctl daemon-reload
          sudo timedatectl set-timezone "$TZ"

      - name: æ‰©å®¹ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@main

      - name: å…‹éš† OpenWrt æºç 
        run: |
          df -hT $GITHUB_WORKSPACE
          git clone --shallow-since=2025-02-23 -b $REPO_BRANCH $REPO_URL openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          echo -e "\e[32mCurrent commit: $(git rev-parse HEAD)\e[0m"

      - name: ç”Ÿæˆè®¾å¤‡å˜é‡
        run: |
          # ç¡®å®š Subnet (å¦‚æœæ˜¯å®šæ—¶è§¦å‘ï¼Œinputsä¸ºç©ºï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼)
          SET_SUBNET="${{ github.event.inputs.subnet || env.DEFAULT_SUBNET }}"
          echo "SUBNET=$SET_SUBNET" >> $GITHUB_ENV
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp $CONFIG_FILE $OPENWRT_PATH/.config
          cd $OPENWRT_PATH
          make defconfig > /dev/null 2>&1
          
          # æå–æºç ä»“åº“å
          echo "SOURCE_REPO=$(echo $REPO_URL | awk -F '/' '{print $(NF)}')" >> $GITHUB_ENV
          # æå–è®¾å¤‡ä¸»æ¶æ„
          echo "DEVICE_TARGET=$(grep CONFIG_TARGET_BOARD .config | awk -F '\"' '{print $2}')" >> $GITHUB_ENV
          # æå–è®¾å¤‡å­æ¶æ„
          echo "DEVICE_SUBTARGET=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F '\"' '{print $2}')" >> $GITHUB_ENV
          # æå–æ¶æ„åŒ…å
          echo "DEVICE_ARCH=$(sed -n 's/^CONFIG_TARGET_ARCH_PACKAGES="\([^"]*\)"/\1/p' .config)" >> $GITHUB_ENV
          # æå–è®¾å¤‡å‹å·
          echo "DEVICE_MODEL=$(sed -n 's/^CONFIG_TARGET_PROFILE="DEVICE_\([^"]*\)"/\1/p' .config)" >> $GITHUB_ENV
          # å†™å…¥ç¼“å­˜æ—¶é—´
          echo "CACHE_DATE=$(date +'%Y-w%V')" >> $GITHUB_ENV

      - name: ç¼“å­˜å·¥å…·é“¾
        # ä»…åœ¨â€œæ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰ç¼“å­˜â€æ—¶å°è¯•æ¢å¤ã€‚å®šæ—¶ä»»åŠ¡(schedule)ä¸è¿è¡Œæ­¤æ­¥(å³ä¸æ¢å¤ï¼Œç›´æ¥å…¨æ–°ç¼–è¯‘)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.cache == 'true'
        uses: actions/cache@v4
        id: cache-toolchain
        with:
          key: ${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.CACHE_DATE }}
          restore-keys: |
            ${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-            
          path: |
            ${{ env.OPENWRT_PATH }}/.ccache
            ${{ env.OPENWRT_PATH }}/staging_dir

      - name: è¾“å‡ºç¼“å­˜ç»“æœ
        if: github.event.inputs.cache == 'true'
        run: |
          echo "ä½¿ç”¨çš„ç¼“å­˜é”®: ${{ steps.cache-toolchain.outputs.cache-key }}"
          echo "ç¼“å­˜å‘½ä¸­æƒ…å†µ: ${{ steps.cache-toolchain.outputs.cache-hit }}"
          echo "ç¼“å­˜ç›®å½•å¤§å°ï¼š"
          du -sh ${{ env.OPENWRT_PATH }}/.ccache || echo ".ccache ç›®å½•ä¸å­˜åœ¨"
          du -sh ${{ env.OPENWRT_PATH }}/staging_dir || echo "staging_dir ç›®å½•ä¸å­˜åœ¨"

      - name: åˆ·æ–°ç¼“å­˜æ—¶é—´æˆ³
        if: github.event.inputs.cache == 'true'
        run: |
          echo "å¼€å§‹åˆ·æ–°ç¼“å­˜æ—¶é—´æˆ³..."
          if [ -d "$OPENWRT_PATH/staging_dir" ]; then
            find "$OPENWRT_PATH/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
              find "$dir" -type f -exec touch {} +
            done
          fi
          echo "ç¼“å­˜æ—¶é—´æˆ³åˆ·æ–°å®Œæˆã€‚"

      - name: æ›´æ–°å¹¶å®‰è£… feeds
        run: |
          cd $OPENWRT_PATH
          sed -i '$a src-git rtp2httpd https://github.com/stackia/rtp2httpd.git' feeds.conf.default
          ./scripts/feeds update -a && ./scripts/feeds install -a      
            
      - name: åŠ è½½è‡ªå®šä¹‰é…ç½®å’Œè„šæœ¬
        env:
          SUBNET: ${{ env.SUBNET }}
        run: |
          if [ -f "$CONFIG_FILE" ]; then
            mv $CONFIG_FILE $OPENWRT_PATH/.config
          fi
          chmod +x $GITHUB_WORKSPACE/scripts/*.sh $CUSTOM_SCRIPT
          cd $OPENWRT_PATH/package/
          $GITHUB_WORKSPACE/scripts/Packages.sh
          $GITHUB_WORKSPACE/scripts/Handles.sh
          $GITHUB_WORKSPACE/$CUSTOM_SCRIPT

      - name: ä¸‹è½½ä¾èµ–
        run: |
          cd $OPENWRT_PATH
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd $OPENWRT_PATH
          mkdir -p files/etc/uci-defaults
          cp $GITHUB_WORKSPACE/scripts/init-settings.sh files/etc/uci-defaults/999-init-settings
          cp $GITHUB_WORKSPACE/scripts/init-tailscale.sh files/etc/uci-defaults/99-init-tailscale
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

      - name: æ•´ç†æ–‡ä»¶
        if: ${{ steps.compile.outputs.status == 'success' }}
        run: |          
          cd $OPENWRT_PATH
          mkdir -p ./artifact/package ./artifact/buildinfo
          find ./bin/packages/ -type f \( -name "*.ipk" -o -name "*.apk" \) -exec cp -f {} ./artifact/package/ \;
          find ./bin/targets/ -type f \( -name "*.buildinfo" -o -name "*.manifest" \) -exec cp -f {} ./artifact/buildinfo/ \;
          cd ./artifact
          tar --transform='s|^package/||' -zcf "${DEVICE_ARCH}_packages.tar.gz" package
          
          cd $OPENWRT_PATH/bin/targets/*/*
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "KERNEL=$(grep '^kernel' *.manifest | sed -n 's/^kernel - \([0-9.]*\)~.*/\1/p')" >> $GITHUB_ENV  
          echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV

      - name: ä¸Šä¼ æ‰€æœ‰äº§ç‰©åˆ° Artifact
        if: ${{ steps.compile.outputs.status == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: nn6000v2
          path: |
            ${{ env.OPENWRT_PATH }}/artifact/*.tar.gz
            ${{ env.FIRMWARE_PATH }}/*sysupgrade*
            ${{ env.FIRMWARE_PATH }}/*factory*
          compression-level: 9
          if-no-files-found: ignore
          overwrite: true

      - name: ä¸Šä¼  Firmware åˆ° Release
        if: ${{ steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true' }}
        uses: ncipollo/release-action@main
        with:
          name: R${{ env.DATE }} for ${{ env.DEVICE_TARGET }}
          allowUpdates: true
          replacesArtifacts: true
          tag: ${{ env.DEVICE_TARGET }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            ${{ env.OPENWRT_PATH }}/artifact/*.tar.gz
            ${{ env.FIRMWARE_PATH }}/*sysupgrade*
            ${{ env.FIRMWARE_PATH }}/*factory*
          body: |
            ### ğŸ“‹ å›ºä»¶ä¿¡æ¯
            -  ğŸ”§ å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
            -  ğŸ“¦ å›ºä»¶æºç : ${{ env.REPO_URL }}
            -  ğŸŒ¿ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
            -  âš™ï¸ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}

      - name: å‘é€ Telegram é€šçŸ¥
        if: ${{ steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true' }}
        run: |
          DT=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
          DL_LINK="https://github.com/${{ github.repository }}/releases/tag/${{ env.DEVICE_TARGET }}"
          
          MSG="<b>ğŸ‰ OpenWrt å›ºä»¶æ„å»ºæˆåŠŸ</b>
          
          <b>è®¾å¤‡ä¿¡æ¯</b>
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          <b>è®¾å¤‡å‹å·:</b> <code>${{ env.DEVICE_MODEL }}</code>
          <b>ç³»ç»Ÿæ¶æ„:</b> ${{ env.DEVICE_TARGET }} / ${{ env.DEVICE_SUBTARGET }}
          <b>å†…æ ¸ç‰ˆæœ¬:</b> ${{ env.KERNEL }}
          <b>æºç åˆ†æ”¯:</b> ${{ env.REPO_BRANCH }}
          
          <b>ğŸ“¦ å‘å¸ƒè¯¦æƒ…</b>
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          <b>ç¼–è¯‘æ—¶é—´:</b> $DT
          <a href='$DL_LINK'><b>ç‚¹å‡»æ­¤å¤„è·³è½¬ä¸‹è½½é¡µé¢</b></a>"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true" \
            --data-urlencode "text=$MSG"

      - name: åˆ é™¤æ—§ç¼“å­˜ (ä»…å®šæ—¶ä»»åŠ¡è¿è¡Œ)
        # åªæœ‰æ˜¯ schedule (å‘¨å…­è‡ªåŠ¨ç¼–è¯‘) æ—¶æ‰æ¸…ç†æ—§ç¼“å­˜ï¼Œä¸ºæ–°çš„ä¸€å‘¨è…¾ç©ºé—´
        if: github.event_name == 'schedule'
        continue-on-error: true
        run: |
          echo "æ£€æµ‹åˆ°å®šæ—¶æ„å»ºï¼Œå‡†å¤‡æ¸…ç†æ—§ç¼“å­˜ä»¥ç”Ÿæˆæ–°çš„ä¸€å‘¨ä¸»ç¼“å­˜..."
          # æœç´¢æ‰€æœ‰ä»¥ä»“åº“+æ¶æ„ä¸ºå‰ç¼€çš„ç¼“å­˜ (ä¸ç®¡å®ƒæ˜¯å“ªä¸€å‘¨çš„)
          gh cache list --key ${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}- --json key --jq '.[] | .key' | while read -r key; do
            echo "åˆ é™¤æ—§ç¼“å­˜: $key"
            gh cache delete "$key" || true
          done