name: 798x

on:
  workflow_dispatch:
    inputs:
      subnet:
        description: "é»˜è®¤IPåœ°å€: 192.168.[X].1"
        required: true
        default: "5"
      cache_toolchain:
        description: "ä½¿ç”¨å·¥å…·é“¾ç¼“å­˜"
        required: true
        default: true
        type: boolean
  schedule:
    - cron: '0 22 * * 5'   # æ¯å‘¨å…­ 06:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6.git
  REPO_BRANCH: openwrt-24.10-6.6
  CONFIG_FILE: mt798x/2410.config
  CUSTOM_SCRIPT: mt798x/custom.sh
  FIRMWARE_RELEASE: true
  CLASH_KERNEL: arm64
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½
        run: |
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "CPU å‹å·: $(awk -F: '/model name/ {print $2; exit}' /proc/cpuinfo)"
          free -h
          df -hT

      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo apt -yqq install dos2unix rename python3-setuptools libfuse-dev
          sudo apt -yqq autoremove --purge
          sudo apt -yqq clean
          sudo timedatectl set-timezone "$TZ"

      - name: æ‰©å®¹ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          root-reserve-mb: 1024

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@main

      - name: å…‹éš† OpenWrt æºç 
        run: |
          git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt
          echo "OPENWRT_PATH=$PWD/openwrt" >> $GITHUB_ENV

      - name: ç”Ÿæˆé…ç½®ä¸è®¾å¤‡å˜é‡
        run: |
          cp $CONFIG_FILE $OPENWRT_PATH/.config
          cd $OPENWRT_PATH
          make defconfig

          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            SUBNET=$(jq -r '.inputs.subnet // empty' "$GITHUB_EVENT_PATH")
            [ -z "$SUBNET" ] && SUBNET="5"
          else
            SUBNET="5"
          fi

          echo "SUBNET=$SUBNET" >> $GITHUB_ENV
          echo "DEVICE_TARGET=$(grep CONFIG_TARGET_BOARD .config | awk -F '\"' '{print $2}')" >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F '\"' '{print $2}')" >> $GITHUB_ENV
          echo "DEVICE_MODEL=$(sed -n 's/^CONFIG_TARGET_PROFILE=\"DEVICE_\\([^\"]*\\)\"/\\1/p' .config)" >> $GITHUB_ENV

      - name: ç¼“å­˜å·¥å…·é“¾
        if: ${{ github.event.inputs.cache_toolchain == 'true' }}
        uses: HiGarfield/cachewrtbuild@main
        with:
          ccache: false
          mixkey: ${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          prefix: ${{ env.OPENWRT_PATH }}

      - name: æ›´æ–°å¹¶å®‰è£… Feeds
        run: |
          cd $OPENWRT_PATH
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ä¸‹è½½ç¬¬ä¸‰æ–¹åŒ…
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/Packages.sh
          cd $OPENWRT_PATH/package
          $GITHUB_WORKSPACE/scripts/Packages.sh

      - name: åŠ è½½è‡ªå®šä¹‰è„šæœ¬
        env:
          SUBNET: ${{ env.SUBNET }}
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/*.sh $GITHUB_WORKSPACE/$CUSTOM_SCRIPT

          cd $OPENWRT_PATH/package     
          $GITHUB_WORKSPACE/scripts/Handles.sh
          $GITHUB_WORKSPACE/$CUSTOM_SCRIPT
          $GITHUB_WORKSPACE/scripts/patch-tailscale.sh       

      - name: ä¸‹è½½æºç ä¾èµ–
        run: |
          cp $CONFIG_FILE $OPENWRT_PATH/.config
          cd $OPENWRT_PATH
          make defconfig
          make download -j8
          find dl -size -1024c -delete

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd $OPENWRT_PATH
          mkdir -p files/etc/uci-defaults
          cp $GITHUB_WORKSPACE/scripts/init-settings.sh files/etc/uci-defaults/99-init-settings
          cp $GITHUB_WORKSPACE/scripts/init-tailscale.sh files/etc/uci-defaults/99-init-tailscale
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

      - name: æ•´ç†å›ºä»¶
        if: steps.compile.outputs.status == 'success'
        run: |
          set -e
          rm -rf $OPENWRT_PATH/artifact
          mkdir -p $OPENWRT_PATH/artifact/{firmware,buildinfo,package}
          cd $OPENWRT_PATH/bin/targets/*/*
          echo "KERNEL=$(grep '^kernel' *.manifest | sed -n 's/^kernel - \([0-9.]*\)~.*/\1/p')" >> $GITHUB_ENV
          echo "DATE=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          find . -name "*squashfs-sysupgrade.bin" -exec cp -f {} $OPENWRT_PATH/artifact/firmware/ \;
          tar -czf $OPENWRT_PATH/artifact/buildinfo/buildinfo.tar.gz config.buildinfo feeds.buildinfo version.buildinfo *.manifest
          cd $OPENWRT_PATH/bin/packages
          find . -type f \( -name "*.ipk" -o -name "*.apk" \) -exec cp -f --parents {} $OPENWRT_PATH/artifact/package/ \;
          cd $OPENWRT_PATH/artifact
          tar -czf packages.tar.gz package
          rm -rf package

      - name: ä¸Šä¼  Artifact
        if: steps.compile.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: mt798x_release
          path: |
            ${{ env.OPENWRT_PATH }}/artifact/**

      - name: å‘å¸ƒåˆ° Release
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        uses: ncipollo/release-action@main
        with:
          tag: ${{ env.DEVICE_TARGET }}
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            ${{ env.OPENWRT_PATH }}/artifact/firmware/*.bin
            ${{ env.OPENWRT_PATH }}/artifact/buildinfo/*.tar.gz
            ${{ env.OPENWRT_PATH }}/artifact/packages.tar.gz
          body: |
            ### ğŸ“‹ å›ºä»¶ä¿¡æ¯
            - ğŸ”§ å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
            - ğŸ§© è®¾å¤‡å‹å·: ${{ env.DEVICE_MODEL }}
            - ğŸ“¦ æºç ä»“åº“: ${{ env.REPO_URL }}
            - ğŸŒ¿ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
            - âš™ï¸ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}

      - name: Telegram é€šçŸ¥
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        run: |
          DT=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
          DL_LINK="https://github.com/${{ github.repository }}/releases/tag/${{ env.DEVICE_TARGET }}"
          
          MSG="<b>ğŸ‰ OpenWrt å›ºä»¶æ„å»ºæˆåŠŸ</b>
          
          <b>è®¾å¤‡ä¿¡æ¯</b>
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          <b>è®¾å¤‡å‹å·:</b> <code>${{ env.DEVICE_MODEL }}</code>
          <b>ç³»ç»Ÿæ¶æ„:</b> ${{ env.DEVICE_TARGET }} / ${{ env.DEVICE_SUBTARGET }}
          <b>å†…æ ¸ç‰ˆæœ¬:</b> ${{ env.KERNEL }}
          <b>æºç åˆ†æ”¯:</b> ${{ env.REPO_BRANCH }}
          
          <b>ğŸ“¦ å‘å¸ƒè¯¦æƒ…</b>
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          <b>ç¼–è¯‘æ—¶é—´:</b> $DT
          <a href='$DL_LINK'><b>ç‚¹å‡»æ­¤å¤„è·³è½¬ä¸‹è½½é¡µé¢</b></a>"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true" \
            --data-urlencode "text=$MSG"