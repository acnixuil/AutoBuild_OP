name: 798x
on:
  workflow_dispatch:
    inputs:
      subnet:
        description: "é»˜è®¤IPåœ°å€:192.168.[].1"
        required: true
        default: "5"
  schedule:
    - cron: '0 22 * * 5'  # æ¯å‘¨äº” UTC 22:00ï¼Œå³æ¯å‘¨å…­ä¸­å›½æ—¶é—´ 6:00

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6.git  
  REPO_BRANCH: openwrt-24.10-6.6
  CONFIG_FILE: mt798x/2410.config
  CUSTOM_SCRIPT: mt798x/custom.sh
  CLASH_KERNEL: arm64
  CACHE_TOOLCHAIN: true
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: mt798x
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04

    steps:

    - name: Check Server Performance
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡: $(nproc --all | grep -c '^')"
        echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
        echo -e "CPUå‹å·ä¿¡æ¯:$(awk -F: '/model name/ {print $2; exit}' /proc/cpuinfo)\n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯: $(sudo lshw -short -C memory | grep GiB)\n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt -yqq update
        sudo -E apt -yqq full-upgrade
        sudo -E apt -yqq autoremove --purge
        sudo -E apt -yqq autoclean
        sudo -E apt -yqq clean
        sudo -E apt -yqq install dos2unix libfuse-dev
        sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo -E apt-get -y install rename clang libclang-dev llvm-dev
        sudo -E systemctl daemon-reload
        sudo -E timedatectl set-timezone "Asia/Shanghai"

    - name: Combine Disks
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 100
        root-reserve-mb: 1024

    - name: Checkout
      uses: actions/checkout@main

    - name: Clone Source Code
      run: |
        git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

    - name: Generate Variables
      run: |
        cp $CONFIG_FILE $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          SUBNET="${{ github.event.inputs.subnet }}"
          [ -z "$SUBNET" ] && SUBNET="5"
        else
          SUBNET="5"
        fi
        echo "SUBNET=$SUBNET" >> $GITHUB_ENV
          
        # æå–æºç ä»“åº“åï¼ˆä¾‹å¦‚ AutoBuild-OpenWrtï¼‰
        echo "SOURCE_REPO=$(echo $REPO_URL | awk -F '/' '{print $(NF)}')" >> $GITHUB_ENV

        # æå–è®¾å¤‡ä¸»æ¶æ„ï¼ˆä¾‹å¦‚ x86ã€qualcommaxï¼‰
        echo "DEVICE_TARGET=$(grep CONFIG_TARGET_BOARD .config | awk -F '\"' '{print $2}')" >> $GITHUB_ENV

        # æå–è®¾å¤‡å­æ¶æ„ï¼ˆä¾‹å¦‚ 64ã€ipq60xxï¼‰
        echo "DEVICE_SUBTARGET=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F '\"' '{print $2}')" >> $GITHUB_ENV

        # æå–æ¶æ„åŒ…åï¼ˆä¾‹å¦‚ x86_64ã€aarch64_cortex-a53ï¼‰
        echo "DEVICE_ARCH=$(sed -n 's/^CONFIG_TARGET_ARCH_PACKAGES="\([^"]*\)"/\1/p' .config)" >> $GITHUB_ENV

        # æå–è®¾å¤‡å‹å·ï¼ˆä¾‹å¦‚ genericã€zn_m2ï¼‰
        echo "DEVICE_MODEL=$(sed -n 's/^CONFIG_TARGET_PROFILE="DEVICE_\([^"]*\)"/\1/p' .config)" >> $GITHUB_ENV

    - name: Cache Toolchain
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false
        mixkey: ${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
        prefix: ${{ env.OPENWRT_PATH }}

    - name: Install Feeds
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a               
        ./scripts/feeds install -a

    - name: Load Custom Configuration
      env:
        SUBNET: ${{ env.SUBNET }}
      run: |
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE $OPENWRT_PATH/.config
        chmod +x $GITHUB_WORKSPACE/scripts/*.sh $CUSTOM_SCRIPT
        cd $OPENWRT_PATH/package/
        $GITHUB_WORKSPACE/scripts/Packages.sh
        $GITHUB_WORKSPACE/scripts/Handles.sh
        $GITHUB_WORKSPACE/$CUSTOM_SCRIPT
        $GITHUB_WORKSPACE/scripts/patch-tailscale.sh        

    - name: Download DL Package
      run: |
        cd $OPENWRT_PATH
        
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware
      id: compile
      run: |
        cd $OPENWRT_PATH
        mkdir -p files/etc/uci-defaults
        cp $GITHUB_WORKSPACE/scripts/init-settings.sh files/etc/uci-defaults/99-init-settings
        cp $GITHUB_WORKSPACE/scripts/init-tailscale.sh files/etc/uci-defaults/99-init-tailscale
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Check Space Usage
      if: (!cancelled())
      run: df -hT

    - name: Upload Bin Directory
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.REPO_URL }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: Prepare artifact
      run: |
        cd $OPENWRT_PATH
        mkdir -p ./artifact/package ./artifact/buildinfo
        cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
        cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/

    - name: Upload buildinfo
      uses: actions/upload-artifact@main
      with:
        name: OpenWrt_buildinfo
        path: ${{ env.OPENWRT_PATH }}/artifact/buildinfo/

    - name: Upload package
      uses: actions/upload-artifact@main
      with:
        name: OpenWrt_package
        path: ${{ env.OPENWRT_PATH }}/artifact/package/

    - name: Organize Files
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        echo "KERNEL=$(grep '^kernel' *.manifest | sed -n 's/^kernel - \([0-9.]*\)~.*/\1/p')" >> $GITHUB_ENV
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        $GITHUB_WORKSPACE/scripts/cleanup_targets.sh
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV

    - name: Upload Firmware To Release
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@main
      with:
        name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.DEVICE_TARGET }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          ğŸ’» **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
          ### ğŸ“‹ å›ºä»¶ä¿¡æ¯
          -  ğŸ”§ å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          -  ğŸ“¦ å›ºä»¶æºç : ${{ env.REPO_URL }}
          -  ğŸŒ¿ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          -  âš™ï¸ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}        

    - name: Send Telegram Message
      run: |
        CURRENT_DATE_TIME=$(TZ='Asia/Shanghai' date +'%Y/%m/%d %r')
        MESSAGE="${{ env.FIRMWARE_TAG }} å›ºä»¶ç¼–è¯‘å®Œæˆ
        å‘å¸ƒæ—¶é—´ï¼š$CURRENT_DATE_TIME
        å‘å¸ƒé¡µé¢ï¼šhttps://github.com/acnixuil/AutoBuild_OP/releases/tag/${{ env.FIRMWARE_TAG }}"
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="$MESSAGE"