name: ipq60xx

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: "é€‰æ‹©ç¼–è¯‘ç‰ˆæœ¬: wifi, nowifi, both"
        required: true
        default: "both"
        type: choice
        options:
          - wifi
          - nowifi
          - both
      subnet_wifi:
        description: "WiFiç‰ˆé»˜è®¤IPåœ°å€:192.168.(X).1 ä¸­çš„Xå€¼"
        required: false
        default: "2"
      subnet_nowifi:
        description: "éWiFiç‰ˆé»˜è®¤IPåœ°å€:192.168.(X).1 ä¸­çš„Xå€¼"
        required: false
        default: "3"

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: k6.12-nss
  CUSTOM_SCRIPT: ipq6000/custom.sh
  CLASH_KERNEL: arm64
  CACHE_TOOLCHAIN: true
  FIRMWARE_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - variant: wifi
            run_this: ${{ github.event.inputs.build_variant == 'both' || github.event.inputs.build_variant == 'wifi' }}
          - variant: nowifi
            run_this: ${{ github.event.inputs.build_variant == 'both' || github.event.inputs.build_variant == 'nowifi' }}
    steps:
      # å½“å½“å‰ variant ä¸éœ€è¦è¿è¡Œæ—¶ï¼Œè¾“å‡ºæç¤ºå¹¶è·³è¿‡åç»­æ­¥éª¤
      - name: Check if current variant should run
        run: |
          if [ "${{ matrix.run_this }}" != "true" ]; then
            echo "Skipping build for ${{ matrix.variant }} variant."
          fi

      - name: Check Server Performance
        if: ${{ matrix.run_this }}
        run: |
          echo "è­¦å‘Šâš "
          echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
          echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡: $(nproc --all | grep -c '^')"
          echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
          echo -e "CPUå‹å·ä¿¡æ¯:$(awk -F: '/model name/ {print $2; exit}' /proc/cpuinfo)\n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯: $(sudo lshw -short -C memory | grep GiB)\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

      - name: Maximize build space
        if: ${{ matrix.run_this }}
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024

      - name: Initialization Environment
        if: ${{ matrix.run_this }}
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi $(docker images -q)
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android $AGENT_TOOLSDIRECTORY
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y update
          sudo -E apt-get -y install $(curl -fsSL is.gd/depends_ubuntu_2204) rename clang libclang-dev llvm-dev
          sudo -E systemctl daemon-reload
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          sudo timedatectl set-timezone "$TZ"

      - name: Checkout
        if: ${{ matrix.run_this }}
        uses: actions/checkout@main

      - name: Clone Source Code
        if: ${{ matrix.run_this }}
        run: |
          df -hT $GITHUB_WORKSPACE
          git clone --shallow-since=2025-02-23 -b $REPO_BRANCH $REPO_URL openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          # å›ºå®šåˆ°æŸä¸ª commitï¼ˆå¯æ ¹æ®éœ€è¦ä¿®æ”¹ï¼‰
          echo -e "\e[32mCurrent commit: $(git rev-parse HEAD)\e[0m"

      - name: Set Variant Configuration
        if: ${{ matrix.run_this }}
        run: |
          if [ "${{ matrix.variant }}" == "wifi" ]; then
            echo "CONFIG_FILE=ipq6000/k612_wifi_m2.config" >> $GITHUB_ENV
            echo "FIRMWARE_TAG=ipq6000" >> $GITHUB_ENV
            echo "RENAME_PREFIX=" >> $GITHUB_ENV
            echo "SUBNET=${{ github.event.inputs.subnet_wifi }}" >> $GITHUB_ENV
          else
            echo "CONFIG_FILE=ipq6000/k612_nowifi_m2.config" >> $GITHUB_ENV
            echo "FIRMWARE_TAG=ipq6000" >> $GITHUB_ENV
            echo "RENAME_PREFIX=nowifi-" >> $GITHUB_ENV
            echo "SUBNET=${{ github.event.inputs.subnet_nowifi }}" >> $GITHUB_ENV
          fi

      - name: Generate Variables
        if: ${{ matrix.run_this }}
        run: |
          cp $CONFIG_FILE $OPENWRT_PATH/.config
          cd $OPENWRT_PATH
          make defconfig > /dev/null 2>&1
          
          # æå–æºç ä»“åº“åï¼ˆä¾‹å¦‚ AutoBuild-OpenWrtï¼‰
          echo "SOURCE_REPO=$(echo $REPO_URL | awk -F '/' '{print $(NF)}')" >> $GITHUB_ENV

          # æå–è®¾å¤‡ä¸»æ¶æ„ï¼ˆä¾‹å¦‚ x86ã€qualcommaxï¼‰
          echo "DEVICE_TARGET=$(grep CONFIG_TARGET_BOARD .config | awk -F '\"' '{print $2}')" >> $GITHUB_ENV

          # æå–è®¾å¤‡å­æ¶æ„ï¼ˆä¾‹å¦‚ 64ã€ipq60xxï¼‰
          echo "DEVICE_SUBTARGET=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F '\"' '{print $2}')" >> $GITHUB_ENV

          # æå–æ¶æ„åŒ…åï¼ˆä¾‹å¦‚ x86_64ã€aarch64_cortex-a53ï¼‰
          echo "DEVICE_ARCH=$(sed -n 's/^CONFIG_TARGET_ARCH_PACKAGES="\([^"]*\)"/\1/p' .config)" >> $GITHUB_ENV

          # æå–è®¾å¤‡å‹å·ï¼ˆä¾‹å¦‚ genericã€zn_m2ï¼‰
          echo "DEVICE_MODEL=$(sed -n 's/^CONFIG_TARGET_PROFILE="DEVICE_\([^"]*\)"/\1/p' .config)" >> $GITHUB_ENV

      - name: Cache Toolchain
        if: ${{ matrix.run_this && env.CACHE_TOOLCHAIN == 'true' }}
        uses: HiGarfield/cachewrtbuild@main
        with:
          ccache: false
          mixkey: ${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          prefix: ${{ env.OPENWRT_PATH }}

      - name: Install Feeds
        if: ${{ matrix.run_this }}
        run: |
          cd $OPENWRT_PATH
          ./scripts/feeds update -a  
          ./scripts/feeds install -a       

      - name: Load Custom Configuration and Custom Script
        if: ${{ matrix.run_this }}
        env:
          SUBNET: ${{ env.SUBNET }}
        run: |
          if [ -f "$CONFIG_FILE" ]; then
            mv $CONFIG_FILE $OPENWRT_PATH/.config
          fi
          chmod +x $GITHUB_WORKSPACE/scripts/*.sh $CUSTOM_SCRIPT
          cd $OPENWRT_PATH/package/
          $GITHUB_WORKSPACE/scripts/Packages.sh
          $GITHUB_WORKSPACE/scripts/Handles.sh
          $GITHUB_WORKSPACE/$CUSTOM_SCRIPT
          $GITHUB_WORKSPACE/scripts/patch-tailscale.sh

      - name: Download DL Package
        if: ${{ matrix.run_this }}
        run: |
          cd $OPENWRT_PATH
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile Firmware
        if: ${{ matrix.run_this }}
        id: compile
        run: |
          cd $OPENWRT_PATH
          mkdir -p files/etc/uci-defaults
          cp $GITHUB_WORKSPACE/scripts/init-settings.sh files/etc/uci-defaults/999-init-settings
          cp $GITHUB_WORKSPACE/scripts/init-tailscale.sh files/etc/uci-defaults/99-init-tailscale
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Organize Files
        if: ${{ matrix.run_this && steps.compile.outputs.status == 'success' }}
        run: |
          cd $OPENWRT_PATH/bin/targets/*/*
          echo "KERNEL=$(grep '^kernel' *.manifest | sed -n 's/^kernel - \([0-9.]*\)~.*/\1/p')" >> $GITHUB_ENV
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          mv -f $OPENWRT_PATH/bin/packages/*/*/*.apk packages
          tar -zcf "${DEVICE_ARCH}_packages.tar.gz" packages
          $GITHUB_WORKSPACE/scripts/cleanup_targets.sh
          rename -v "s/^/R$(date +'%y.%m.%d')-${{ env.RENAME_PREFIX }}/" *.ubi
          rename -v "s/^/R$(date +'%y.%m.%d')-${{ env.RENAME_PREFIX }}/" *.bin
          echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
          echo "DATE1=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Upload Firmware To Artifact
        if: ${{ matrix.run_this }}
        continue-on-error: true
        uses: actions/upload-artifact@main
        with:
          name: ${{ env.DEVICE_MODEL }}-${{ env.DATE1 }}
          path: ${{ env.FIRMWARE_PATH }}

      - name: Upload Firmware To Release
        if: ${{ matrix.run_this && steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true' }}
        uses: ncipollo/release-action@main
        with:
          name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
          allowUpdates: true
          replacesArtifacts: true
          tag: ${{ env.DEVICE_TARGET }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          body: |
            ğŸ’» **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
            ### ğŸ“‹ å›ºä»¶ä¿¡æ¯
            -  ğŸ”§ å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
            -  ğŸ“¦ å›ºä»¶æºç : ${{ env.REPO_URL }}
            -  ğŸŒ¿ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
            -  âš™ï¸ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}

      - name: Send Telegram Message
        if: ${{ matrix.run_this }}
        run: |
          CURRENT_DATE_TIME=$(TZ='Asia/Shanghai' date +'%Y/%m/%d %r')
          MESSAGE="${{ env.FIRMWARE_TAG }} å›ºä»¶ç¼–è¯‘å®Œæˆ
          å‘å¸ƒæ—¶é—´ï¼š$CURRENT_DATE_TIME
          å‘å¸ƒé¡µé¢ï¼šhttps://github.com/acnixuil/AutoBuild_OP/releases/tag/${{ env.FIRMWARE_TAG }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MESSAGE"
